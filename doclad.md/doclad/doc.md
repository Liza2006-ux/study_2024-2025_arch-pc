---
## Front matter
title: "Доклад по теме использования rsync для резервного
копирования данных."
subtitle: "Операционные системы"
author: "Волчкова Eлизавета Дмитриевна"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian

polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Актуальность.
Утилита Rsync остаётся актуальной, так как её последняя версия на 15 января 2025 года — 3.4.1.  
Rsync — программа для UNIX-подобных систем, которая эффективно выполняет синхронизацию файлов и каталогов в двух местах с минимизированием трафика. Она поддерживает коннект по зашифрованным каналам SSH и SSL, а также сжатие данных перед их передачей.  
Некоторые особенности Rsync:
Выборочная синхронизация. Можно синхронизировать как отдельные файлы, так и целую структуру каталогов/
Передача только изменённых блоков. Благодаря этому задача выполняется даже при наличии только «узкого» сетевого канала.  
Сохранение метаданных. Можно сохранять разрешения доступа, атрибуты чтения-записи, время создания-редактирования файлов. 














# Rsync
  Rsync — это утилита для удалённого и локального копирования и синхронизации файлов и каталогов в системах Linux/Unix. Она подходит для резервного копирования данных и зеркалирования между двумя компьютерами Linux. 3
Некоторые особенности использования Rsync для резервного копирования:
При первой синхронизации данные файлов копируются целиком. При повторной — Rsync проверяет наличие изменений в исходном файле и передаёт лишь изменённые блоки и байты. 1
Для работы не требуются права root. 1
Можно выполнять автоматическую синхронизацию данных с рабочего сервера на резервный. В случае проблем на продуктивном сервере можно быстро перевести всё на резервный. 2
Некоторые примеры команд для резервного копирования с помощью Rsync:
Копирование директории на локальном компьютере. Например, чтобы скопировать директорию /var/www/site в директорию для резервных копий, нужно выполнить команду 
rsync -zvr /var/www/site /backup/
. Опция -r позволит рекурсивно скопировать все вложенные директории и файлы. 32
Сохранение всех атрибутов файлов при копировании. Для этого нужно добавить ключ -a. Например, команда 
rsync -zvra /var/www/site /backup/ сохранит дату изменения и дату создания файлов. 2
Копирование только изменённых файлов. Для этого нужно добавить опцию -c. Например, команда 
rsync -zvrac /var/www/site /backup/
 скопирует в целевую директорию только изменённый файл. 2
Автоматическое удаление файлов из директории для бэкапов. Для этого нужно добавить опцию —delete. Она позволит сравнить файлы с источником и в случае присутствия файла в целевой директории и отсутствия его в исходной директории, удалить его автоматически. 2
Для принудительного использования SSH-протокола для копирования файлов нужно указать это в команде (для выбора транспортного протокола копирования файлов используется опция –e). Команда: 
rsync -zvrae ssh root@IP:/backup/ /backup/. Выбор опций и настройка Rsync зависят от конкретных задач и предпочтений пользователя.
Резервное копирование rsync-ом
Настройка Linux
Если у тебя на компьютере не хранится дорогих тебе фотографий или
документов, эта заметка будет тебе не интересна. Если ты уже делаешь резервные копии и механизм работы с ними тебя полностью устраивает, эту заметку тоже лучше пропустить. Если ты считаешь, что хорошо разбираешься в linux, то вряд ли почерпнёшь в ней что-то новое. Для остальных — делюсь .

Зачем нужно делать резервные копии важных данных?

               Как сказал Воланд в «Мастер и Маргарита», ужасно не то, что человек смертен, а то, что он внезапно смертен. То же самое верно относительно жёстких дисков. У меня за мою жизнь сдохло, кажется, всего 2 НЖМД, один сдох внезапно (очень ценные данные были утеряны), другой — почти внезапно (удалось восстановить часть данных), ситуация среди моих знакомых в среднем отличается не сильно. Статистика смерти винтов есть куда менее субъективная, от гугла — в среднем винт живёт несколько лет, и в 60% случаев винты дохнут внезапно, даже для S.M.A.R.T.

              Кроме аппаратных, есть ещё и программные причины утери данных — однажды вирус WIN95.CIH снёс первые несколько мегабайт диска, включая FAT, что привело к полной недоступности данных. Ушёл месяц яростного программирования и лазанья с DiskEdit, чтобы в условиях отсутствия Интернета разобраться со структарами FAT-а и восстановить их. Однажды Patrition Magic завис при переносе раздела. Однажды при работе
Partition Magic-а отключили электричество в щитке на лестничной площадке. В последних двух случаях важные данные не потерялись — но это просто везение. Если вы подключены к сети, то есть вероятность взлома и уничтожения важных данных злоумышленником. От такого рода повреждений RAID-массив уже не спасёт.

Как оценить целесообразность бэкапа?

                     Есть такое понятие, как жёсткость риска — это вероятность возникновения риска, помноженная на стоимость риска в деньгах. Стоимость риска в данном случае — это то, сколько ты готов был бы заплатить денег за восстановление всей утеряной информации. Оценим вероятность риска снизу.                                                            Вероятность смерти жёсткого диска за 3 года — не менее 24% в любом случае, независимо от того, новый он или нет. Вероятность, что смерть будет внезапной, как я уже писал, 60%. Итого вероятность внезапной смерти за 3 года — 14%. 
Если используются два ЖД без зеркалирования, вероятность смерти хотя бы одного из них за этот период — 26%.
Конечно, нужно учитывать и ценность данных на этих дисках — у меня 2 ЖД с ценными данными (потеря любого фатальна) и один с музыкой и фильмами — расстраиваться о утери коллекции избранной мною музыки буду, но переживу.
Безопасность.
Жёсткий диск содержит данные, безопасность которых нужна не только мне Соответственно, диск шифруем. В debian всё делается из коробки за несколько минут и  смогу потом с лёгкостью эти данные восстановить, главное — не забыть записать используемый каскад алгоритмов и подсказку к паролю на бумажке и хранить её в коробке с винтом. 


# Практика.

      Давайте забэкапить все неиспользуемые (те, которые на всякий случай лучше не терять) разделы целиком, для теста взял раздел с когда-то установленным 
WIN98:

#cp/dev/hda1/mnt/backup/images/
тестируем:
#mkdir/mnt/hda1-backup-test
#mount /mnt/backup/images/hda1 /mnt/hda1-backup-test -o loop
#ls/mnt/hda1-backup-test/
boot.iniio.sysntdetect.com 
Так как рабочие данные у меня находятся в файловых системах ext2 и ext3, хочется использовать тот факт, что аттрибуты файлов в ext2/ext3 могут содержать информацию о его бэкапе.
 Однако, dump использовать крайне не рекомендуется на смонтированных файловых системах — www.rhd.ru/docs/manuals/enterprise/RHEL-4-Manual/admin-guide/s1-disaster-rhlspec.html, dump.sourceforge.net/isdumpdeprecated.html. Появляется огромный выбор между общими технологиями бэкапа — tar, cpio, backup-manager, bacula и так далее, но я пока остановился на rsync + cp — ибо результат можно будет прозрачно прочитать где угодно, ничего не распаковывая и не считывая все инкрементальные архивы.

$ sudo rsync --archive --one-file-system /etc /home /root --delete /mnt/backup/rsync/`date +%F--%H-%M`
Нужно сохранить несколько последних бэкапов? Пожалуйста, используем то, что параметр --link у cp создаёт жёсткую ссылку на файл вместо его копирования.
$ sudo rsync --archive --one-file-system /etc /home /root --delete /mnt/backup/rsync/latest/
$ sudo cp --archive --link /mnt/backup/rsync/latest/
/mnt/backup/rsync/`date +%F--%H-%M`

# Проверяем:
$ ls /mnt/backup/rsync/
2008-04-03--04-29 2008-04-03--04-34 latest
Хочется увидеть различия с бэкапом? «Эмулируем» копирование текущего состояния в состояние бэкапа.
$ sudo rsync --archive --dry-run --verbose --one-file-system /etc /home /root --delete /mnt/backup/rsync/latest/
Хочется увидеть различия между бэкапами? Аналогично.
$ sudo rsync --archive --dry-run --verbose --delete
/mnt/backup/rsync/2008-04-03--04-41/
/mnt/backup/rsync/2008-04-03--04-29/



Утилиту Rsync можно использовать для копирования и синхронизации файлов и папок с локального сервера Linux на удаленный и наоборот. Rsync позволяет копировать ваши данные между серверами внутри защищенного SSH соединения. Так же, rsync, поддерживает сжатие данных на лету, что повышает производительность системы.

         Чтобы исключить потерю информации при отправке файлов, rsync сначала копирует всю передаваемую информацию во временный файл. Другая важная особенность rsync – файлы передаются в один поток, не создается отдельный поток для каждого файла (что вызывает проблему при передаче большого количества маленьких файлов в других утилитах).



\
Установка и основные параметр rsync
Установка rsync не отличается от установки, любого другого пакета. В CentOS пакет rsync присутствует в базовом репозитории и устанавливается через yum (или dnf в CentOS 8):
# yum install rsync -y
Синтаксис команды выглядит следующим образом:
# rsync опции источник приемник
В качестве источника и приемника можно указать локальную или удаленную директорию на другом сервере.
Опции:
-v – вывести подробную информацию о процессе
-c – проверка контрольных сумм файлов
-q – минимальная информация
-a – режим архивирования
-R – относительные пути
-y – не перезаписывать более новые файлы
-b – создание резервной копии
-l – копировать симлинки
-L – копировать содержимое ссылок
-H – копировать жесткие ссылки
-g – сохранять группу
-p – сохранять права для файлов
-t – сохранять время модификаций
-x – работать только в этой ФС
-e – использовать другой транспортный протокол (например, ssh)
-z – сжимать файлы перед передачей
—delete – удалять файлы которых нет в источнике
—exclude – исключить файлы
—recursive – перебирать директории рекурсивно
—no-recursive – отключить рекурсию
—progress – выводить прогресс передачи файлов
—stat – показать статистику передачи
—max-size – максимальный размер файла для передачи
—bwlimit — ограничение скорости для передачи файлов
—version – версия утилиты
Rsync: локальное копирование/синхронизация каталогов
Rsync можно использовать для копирования файлов между локальными директориями сервера. Если вам нужно скопировать файлы из одной директории в другую, выполните команду:
# rsync /var/www/html/package.zip /var/www/tmp/
В этом случае файл package.zip был просто скопирован в директорию /var/www/tmp/.
Можно добавить несколько опций для выполнения копирования. Например, чтобы перед выполнением копирования предварительно сжать файл, вывести подробную информацию и прогресс копирования файла, выполните:
# rsync -vz --progress /var/www/html/package.zip /var/www/tmp/
![image](https://github.com/user-attachments/assets/e00f9dc1-7d53-4c6c-b86e-13d9688fb364)

Вы можете использовать rsync для синхронизации содержимого локальных каталогов. Например, rsync удобно использовать, когда вам требуется скопировать файлы из рабочей директории, на хранилище, которое примонтировано к какому-то разделу. Несколько примеров команд:
# rsync -zvr /var/www/site /backup/
Мы скопировали директорию /var/www/site в директорию для резервных копий, опция -r позволила рекурсивно скопировать все вложенные директории и файлы.
Чтобы сохранить все атрибуты файлов при копировании, например, дату изменения и дату создания файлов, добавьте ключ -a:
# rsync -zvra /var/www/site /backup/
![image](https://github.com/user-attachments/assets/fba37859-d43f-4267-87f5-456a105b5335)

Если вы хотите скопировать только измененные файлы, добавьте опцию -c:
# rsync -zvrac /var/www/site /backup/
Я измeнил только один файл и запустил команду. В результате в целевую директорию, был скопирован только измененный файл.
![image](https://github.com/user-attachments/assets/ab775345-bbdc-4e75-a8ac-b99af634846e)

Очень удобно использовать такую опцию, если файлы меняются не часто. Таким образом вы экономите время на копирование/синхронизацию директории.
Чтобы не захламлять директорию для бэкапов, можно добавить опцию —delete, это позволит сравнить файлы с источником и в случае присутствия файла в целевой директории и отсутствие его в исходной директории, удалить его автоматически. Но призываю использовать данную опцию с осторожностью, так как если вы настроите копирование директории по крону, в случае сбоя или вмешательства из вне в рабочую директорию, с последующим удалением рабочих файлов, у вас затрется информация и в бэкапах, что не позволит вам восстановить ваши данные. Пример:
# rsync -zvrac --delete /var/www/site /backup/

![image](https://github.com/user-attachments/assets/3e1daee3-e3e9-42f7-a66a-ecbf5ed27912)

Rsync: настройка синхронизации с удаленным сервером
Чаще всего копирование/синхронизация rsync с удаленным сервером используется для резервного копирования или синхронизации конфигурации нод кластера. Можно выполнять автоматическую синхронизацию данных с рабочего сервера на резервный, и в случае проблем на продуктивном севере быстро все перевести на резервный. Это довольно удобный и простой в настройке вариант.
В современных версиях rsync протокол SSH используется для передачи файлов по-умолчанию. Однако вы можете использовать и демон rsyncd. Для этого клиент rsync должен быть установлен на удаленном компьютере, и его демон добавлен в автозагрузку:
# systemctl enable rsyncd
Конфигурационный файл rsync — /etc/rsyncd.conf. В этом файле можно настроить параметры rsync и настройки для синхронизации для разных ресурсов.
Для синхронизации через демона rsync адрес удаленного сервера указывается так rsync://. Например:
# rsync -av /var/www/site/package.zip rsync://192.168.1.32/backup
Чтобы скопировать файл на удаленный сервер, используйте команду:
# rsync -az /var/www/site/package.zip root@IP:/backup/
Где IP, это адрес удаленного сервера. После запуска команды, удаленный сервер запросит пароль пользователя (если включена авторизация по паролю). Для автоматической авотризации нужно настроить SSH ключи.
Скопируем директорию с локального сервера на удаленный:
# rsync -zvra /var/www/site root@IP:/backup/
![image](https://github.com/user-attachments/assets/8545de6d-cbea-48ec-a5b7-29c68737031d)

То есть, все тоже самое, что и с локальными директориями, только мы указываем адрес удаленного сервера.
Так же вы можете синхронизировать файлы и с удаленного сервера на локальный, команда для этого немного изменится:
# rsync -zvra root@IP:/backup/ /backup
![image](https://github.com/user-attachments/assets/3351a8a1-c5d0-4811-b040-845225975208)

Для принудительного использования SSH протокола для копирования файлов, укажите это в вашей команде (для выбора транспортного протокола копирования файлов используется опция –e):
# rsync -zvrae ssh root@IP:/backup/ /backup
Если удаленный SSH сервер имеет отличный от стандартного порт, его так же можно указать:
# rsync -zvrae "ssh -p 2222" root@IP:/backup/ /backup
Другие примеры использования rsync
Если в рамках сессии синхронизации вы передаете много информации и важно ограничить скорость передачи, задайте это дополнительной опцией –bwlimit (указывается скорость в КБ/с):
# rsync -zvra --bwlimit=100 /var/www/site root@IP:/backup/
При передаче файлов на удаленный сервер, вы можете ограничить максимальный размер файлов, которые нужно скопировать. Например, вы хотите скопировать все файлы, кроме файлов размером более 1 Мб:
# rsync -zvra --max-size='1m' /var/www/site root@IP:/backup/
Если у вас на сервере нужна односторонняя синхронизация и после переноса файлов на удаленный сервер нужно удалить файлы с исходного сервера, воспользуйтесь опцией —-remove-source-files:
# rsync -zvra --remove-source-files --progress /var/www/site/package.zip root@IP:/backup/
После выполнения команды, файл был скопирован на удаленный сервер и удален на источнике:
![image](https://github.com/user-attachments/assets/170c5db2-b393-45ed-bf86-1157af575449)

Так же очень удобный опции —include и —exclude, с помощью этих опций, можно делать исключения по копированию директорий или файлов:
# rsync -zvra --exclude=administrator/ /var/www/site root@IP:/backup/
![image](https://github.com/user-attachments/assets/12ba45da-2930-49bc-a62c-6bc0b0bcea1d)

В данном случае мы исключили директорию “administrator” при копировании на удаленный сервер.
# rsync -zvra --include='*.php' --exclude='*' /var/www/site/administrator/ root@IP:/backup/![image](https://github.com/user-attachments/assets/18b403dc-b2cc-4897-8fe9-cc244fc8be7b)
![Uploading image.png…]()

Добавлением опции —include мы смогли задать фильтр по файлам, скопировали только файлы с расширением php.
Резервное копирование в Linux с помощью rsync
В своей рабое я часть использую rsync для автоматических задач резервного копирования в Linux. Можно написать простые bash скрипты или просто добавить команду rsync в cron и выполнять по расписанию.
Например, можно добавить в cron команду:
01 30 * * * rsync -zvra root@IP:/backup/ /backup
По итогу  каждый день в 1-30 ночи, будет выполняться синхронизация каталогов локального и удаленного серверов.
Важно, что для выполнения команды rsync на удаленном сервер через cron, желательно настроить авторизацию серверов по SSH ключу. Примеры скриптов для бэкапа, мы приводили в статье «Скрипты для бэкапа файлов из Linux в облако», там как раз используется rsync для копирования файлов в подключенные облачные хранилища.
# Список литературы.
1.https://winitpro.ru/index.php/2019/12/18/rsync-sinhronizaciya-v-linux/
2.https://habr.com/ru/articles/51419/

3.https://selectel.ru/blog/rsync-guide/
4.https://proglib.io/p/kak-ispolzovat-rsync-dlya-rezervnogo-kopirovaniya-faylov-vashih-vds-2021-10-20


